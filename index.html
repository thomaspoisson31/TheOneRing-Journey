<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voyages en Terre du Milieu v1.1.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="styles.css" rel="stylesheet">
</head>
<body class="bg-gray-800 text-white h-screen">

    <!-- Header supprim√© - carte occupe 100% de l'espace -->

    <!-- Loader Overlay -->
    <div id="loader-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-500"></div>
            <p class="mt-4 text-xl text-gray-300">Chargement de la carte...</p>
        </div>
    </div>

    <!-- Main container -->
    <div class="h-full relative">
        <!-- Toolbar -->
        <div id="toolbar" class="absolute top-4 left-4 z-10 bg-gray-900 bg-opacity-80 p-2 rounded-lg shadow-xl flex flex-col space-y-2 border border-gray-700">
            <!-- Authentication Button en premier -->
            <button id="auth-btn" title="Authentification et sauvegarde" class="w-10 h-10 bg-gray-700 hover:bg-blue-600 rounded transition-colors relative overflow-hidden">
                <i id="auth-icon" class="fas fa-user"></i>
                <img id="user-profile-pic" class="absolute inset-0 w-full h-full object-cover rounded hidden" alt="Photo de profil">
            </button>
            <hr class="border-gray-600">
            <button id="draw-mode" title="Mode Dessin" class="w-10 h-10 bg-gray-700 hover:bg-blue-600 rounded transition-colors"><i class="fas fa-pencil-alt"></i></button>
            <button id="erase" title="Effacer le trac√©" class="w-10 h-10 bg-gray-700 hover:bg-red-600 rounded transition-colors"><i class="fas fa-eraser"></i></button>
            <hr class="border-gray-600">
            <button id="add-location-mode" title="Ajouter un lieu" class="w-10 h-10 bg-gray-700 hover:bg-blue-600 rounded transition-colors"><i class="fas fa-map-marker-alt"></i></button>
            <button id="add-region-mode" title="Cr√©er une r√©gion" class="w-10 h-10 bg-gray-700 hover:bg-blue-600 rounded transition-colors"><i class="fas fa-draw-polygon"></i></button>
            <hr class="border-gray-600">
            <button id="filter-toggle" title="Filtrer les lieux" class="w-10 h-10 bg-gray-700 hover:bg-blue-600 rounded transition-colors"><i class="fas fa-filter"></i></button>
            <button id="map-switch" title="Changer de carte" class="w-10 h-10 bg-gray-700 hover:bg-blue-600 rounded transition-colors hidden"><i id="map-switch-icon" class="fas fa-users"></i></button>
            <hr class="border-gray-600">
            <button id="export-locations" title="Exporter lieux et r√©gions" class="w-10 h-10 bg-gray-700 hover:bg-green-600 rounded transition-colors"><i class="fas fa-file-export"></i></button>
            <button id="import-locations" title="Importer lieux et r√©gions" class="w-10 h-10 bg-gray-700 hover:bg-green-600 rounded transition-colors"><i class="fas fa-file-import"></i></button>
            <input type="file" id="import-file-input" class="hidden" accept=".json">
            <!-- Anciens boutons masqu√©s - maintenant g√©r√©s par les boutons unifi√©s ci-dessus -->
            <button id="import-regions" title="Importer des r√©gions" class="w-10 h-10 bg-gray-700 hover:bg-green-600 rounded transition-colors hidden"><i class="fas fa-file-upload"></i></button>
            <input type="file" id="import-regions-input" class="hidden" accept=".json">
            <button id="export-regions" title="Exporter des r√©gions" class="w-10 h-10 bg-gray-700 hover:bg-green-600 rounded transition-colors hidden"><i class="fas fa-file-download"></i></button>
            <hr class="border-gray-600">
            <!-- Settings Button -->
            <button id="settings-btn" title="Param√®tres" class="w-10 h-10 bg-gray-700 hover:bg-yellow-600 rounded transition-colors">
                <i class="fas fa-cog"></i>
            </button>
        </div>

        <!-- Filter Panel -->
        <div id="filter-panel" class="hidden absolute top-4 left-20 z-10 bg-gray-900 bg-opacity-80 p-4 rounded-lg shadow-xl border border-gray-700 w-64">
            <h3 class="text-lg font-bold mb-4">Filtrer les lieux</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300">Statut</label>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="filter-known" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="filter-known" class="ml-2 block text-sm text-gray-300">Connu</label>
                        </div>
                        <div class="flex items-center">
                            <input id="filter-visited" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="filter-visited" class="ml-2 block text-sm text-gray-300">Visit√©</label>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Couleurs</label>
                    <div id="filter-color-picker" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Affichage</label>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="filter-show-regions" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="filter-show-regions" class="ml-2 block text-sm text-gray-300">Afficher les r√©gions</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6">
                <button id="reset-filters" class="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors">Tout afficher</button>
            </div>
        </div>

        <!-- Travel Info Panel (always visible) -->
        <div id="distance-container" class="absolute top-4 right-4 z-10 bg-gray-900 bg-opacity-80 p-3 rounded-lg shadow-xl border border-gray-700 text-sm max-w-xs">
            <!-- Date du jour ajout√©e -->
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                    <div id="season-indicator" class="text-sm cursor-pointer hover:scale-110 transition-transform mr-2" title="Cliquez pour ouvrir les param√®tres de saison">üå±</div>
                    <div id="calendar-date-indicator" class="text-sm text-gray-300 cursor-pointer hover:text-white transition-colors" title="Cliquez pour ouvrir les param√®tres de saison">1 Gwaeron</div>
                </div>
            </div>
            <div class="flex items-center space-x-2 mb-2">
                <div id="distance-display" class="text-sm"></div>
                <button id="voyage-segments-btn" title="G√©rer le voyage" class="hidden bg-green-600 hover:bg-green-700 rounded-full w-8 h-8 flex items-center justify-center text-white">
                    <i class="fas fa-route"></i>
                </button>
            </div>
            <!-- D√©tail du voyage r√©activ√© -->
            <div id="journey-info" class="space-y-2 border-t border-gray-600 pt-2">
                <div id="traversed-regions-info" class="hidden">
                    <div class="font-semibold text-blue-400 mb-1">D√©couvertes du voyage :</div>
                    <div id="traversed-regions-list" class="text-gray-300"></div>
                </div>
                <div id="nearby-locations-info" class="hidden">
                    <div class="font-semibold text-blue-400 mb-1">Lieux √† proximit√© :</div>
                    <div id="nearby-locations-list" class="text-gray-300"></div>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div id="info-box">
            <div id="info-box-header">
                <div id="info-box-title" class="hidden text-xl font-bold text-white flex-grow mr-4"></div>
                <div id="info-box-controls">
                    <i id="info-box-edit" class="fas fa-pencil-alt" title="Modifier"></i>
                    <i id="info-box-delete" class="fas fa-trash hidden" title="Supprimer"></i>
                    <i id="info-box-expand" class="fas fa-expand" title="Vue √©tendue"></i>
                    <i id="info-box-close" class="fas fa-times" title="Fermer"></i>
                </div>
            </div>
            <div id="info-box-tabs">
                <button class="tab-button active" data-tab="image">Image</button>
                <button class="tab-button" data-tab="text">Texte</button>
                <button class="tab-button" data-tab="rumeurs">Rumeurs</button>
                <button class="tab-button" data-tab="tradition">Tradition Ancienne</button>
                <button class="tab-button" data-tab="tables">Tables al√©atoires</button>
            </div>
            <div id="info-box-scroll-wrapper">
                <div id="info-box-content">
                    <div id="image-tab" class="tab-content active">
                        <div class="image-view">
                            <div class="image-placeholder">Aucune image disponible</div>
                        </div>
                    </div>
                    <div id="text-tab" class="tab-content">
                        <div class="text-view">
                            <h3></h3>
                            <p></p>
                        </div>
                    </div>
                    <div id="rumeurs-tab" class="tab-content">
                        <div class="text-view">
                            <h3>Rumeurs</h3>
                            <p></p>
                        </div>
                    </div>
                    <div id="tradition-tab" class="tab-content">
                        <div class="text-view">
                            <h3>Tradition Ancienne</h3>
                            <p></p>
                        </div>
                    </div>
                    <div id="tables-tab" class="tab-content">
                        <div class="text-view">
                            <h3>Tables al√©atoires</h3>
                            <div class="image-placeholder">Aucune table disponible</div>
                        </div>
                    </div>
                </div>
                <div id="info-box-edit-content" class="hidden"></div>
            </div>
        </div>

        <!-- Viewport -->
        <div id="viewport" class="w-full h-full overflow-hidden bg-gray-800">
            <div id="map-container">
                <img id="map-image" src="" alt="Carte Joueur" class="opacity-0">
                <img id="loremaster-map-image" src="" alt="Carte Gardien" class="opacity-0">
                <canvas id="drawing-canvas"></canvas>
                <svg id="regions-layer" xmlns="http://www.w3.org/2000/svg"></svg>
                <div id="locations-layer"></div>
            </div>
        </div>

        <!-- Add Location Modal -->
        <div id="add-location-modal" class="hidden absolute inset-0 z-40 bg-black bg-opacity-70 flex items-center justify-center">
            <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 shadow-xl w-full max-w-sm">
                <h3 class="text-lg font-bold mb-4">Ajouter un nouveau lieu</h3>
                <div class="space-y-4">
                    <div>
                        <label for="location-name-input" class="block text-sm font-medium text-gray-300">Nom du lieu</label>
                        <input type="text" id="location-name-input" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="location-desc-input" class="block text-sm font-medium text-gray-300">Description</label>
                        <div class="flex items-center space-x-2">
                           <textarea id="location-desc-input" rows="2" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                           <button id="generate-add-desc" class="mt-1 p-2 bg-purple-600 hover:bg-purple-700 rounded-md" title="G√©n√©rer une description"><span class="gemini-icon">‚ú®</span></button>
                        </div>
                    </div>
                    <div>
                        <label for="location-image-input" class="block text-sm font-medium text-gray-300">URL de l'image (optionnel)</label>
                        <input type="url" id="location-image-input" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Couleur</label>
                        <div id="add-color-picker" class="flex space-x-2 mt-1"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Statut</label>
                        <div class="flex items-center space-x-4 mt-1">
                            <div class="flex items-center">
                                <input id="location-known-input" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="location-known-input" class="ml-2 block text-sm text-gray-300">Connu</label>
                            </div>
                            <div class="flex items-center">
                                <input id="location-visited-input" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="location-visited-input" class="ml-2 block text-sm text-gray-300">Visit√©</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button id="cancel-add-location" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors">Annuler</button>
                    <button id="confirm-add-location" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">Ajouter</button>
                </div>
            </div>
        </div>

        <!-- Journey Log Modal -->
        <div id="journey-log-modal" class="hidden absolute inset-0 z-40 bg-black bg-opacity-70 flex items-center justify-center p-4">
            <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold" id="voyage-modal-title">Chronique de Voyage</h3>
                    <button id="close-journey-log" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
                </div>
                <div id="journey-log-content" class="prose prose-invert overflow-y-auto text-gray-300"></div>
            </div>
        </div>

        <!-- Add Region Modal -->
        <div id="add-region-modal" class="hidden absolute inset-0 z-40 bg-black bg-opacity-70 flex items-center justify-center">
            <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 shadow-xl w-full max-w-sm">
                <h3 class="text-lg font-bold mb-4">Cr√©er une nouvelle r√©gion</h3>
                <div class="space-y-4">
                    <div>
                        <label for="region-name-input" class="block text-sm font-medium text-gray-300">Nom de la r√©gion</label>
                        <input type="text" id="region-name-input" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="region-desc-input" class="block text-sm font-medium text-gray-300">Description</label>
                        <textarea id="region-desc-input" rows="3" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Couleur</label>
                        <div id="region-color-picker" class="flex space-x-2 mt-1"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button id="cancel-add-region" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors">Annuler</button>
                    <button id="confirm-add-region" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">Cr√©er</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Map Modal -->
        <div id="map-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
            <div class="bg-gray-800 rounded-lg p-6 w-[90vw] max-w-md mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold" id="map-modal-title"><i class="fas fa-map-marked-alt mr-2"></i>Ajouter une carte</h3>
                    <button id="close-map-modal" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label for="map-name-input" class="block text-sm font-medium text-gray-300 mb-2">Nom de la carte</label>
                        <input type="text" id="map-name-input" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Nom de la carte">
                    </div>

                    <div>
                        <label for="map-file-input" class="block text-sm font-medium text-gray-300 mb-2">Fichier image</label>
                        <input type="file" id="map-file-input" accept=".webp,.png,.jpg,.jpeg" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                        <div class="text-xs text-gray-400 mt-1">Formats accept√©s : WEBP, PNG, JPG (recommand√© : 5103 √ó 3296 px)</div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Type de carte</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="map-type" value="player" class="mr-2" checked>
                                <span class="text-sm">Carte Joueur</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="map-type" value="loremaster" class="mr-2">
                                <span class="text-sm">Carte Gardien</span>
                            </label>
                        </div>
                    </div>

                    <div id="map-preview-container" class="hidden">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Aper√ßu</label>
                        <div class="aspect-video bg-gray-700 rounded-lg flex items-center justify-center overflow-hidden">
                            <img id="map-preview-image" class="w-full h-full object-cover" alt="Aper√ßu">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancel-map-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg">Annuler</button>
                    <button id="save-map-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">
                        <span id="save-map-text">Ajouter</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Authentication Panel Modal -->
        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
            <div class="bg-gray-800 rounded-lg p-6 max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold"><i class="fas fa-user mr-2"></i>Authentification & Sauvegarde</h3>
                    <button id="close-auth-modal" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="auth-status-panel">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <p class="text-center text-gray-400">V√©rification de l'authentification...</p>
                </div>

                <div id="auth-content-panel" class="hidden">
                    <div id="logged-in-panel" class="hidden">
                        <div class="bg-green-900/20 border border-green-500 rounded p-4 mb-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <i class="fas fa-check-circle text-green-500 text-xl mb-2"></i>
                                    <p class="text-green-400">Connect√© avec Google</p>
                                    <p class="font-bold" id="auth-user-name"></p>
                                </div>
                                <a href="/auth/logout" class="text-red-400 hover:text-red-300 text-sm">
                                    <i class="fas fa-sign-out-alt mr-1"></i>D√©connexion
                                </a>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <h4 class="font-bold mb-2"><i class="fas fa-save mr-2"></i>Sauvegarder le contexte actuel</h4>
                                <div class="flex space-x-2">
                                    <input type="text" id="context-name-input" placeholder="Nom du contexte" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                                    <button id="save-context-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">
                                        <i class="fas fa-save"></i>
                                    </button>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-bold mb-2"><i class="fas fa-folder-open mr-2"></i>Contextes sauvegard√©s</h4>
                                <div id="saved-contexts" class="space-y-2 max-h-40 overflow-y-auto">
                                    <!-- Contexts will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="logged-out-panel" class="hidden">
                        <button id="google-signin-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-white text-black rounded-lg shadow-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.71h6.14c-.27 1.53-1.03 2.83-2.15 3.72v3.13h3.85c.18-.06.36-.09.56-.09.69 0 1.29.49 1.47 1.15z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.67l-3.85-3.13c-.54.37-1.25.59-2.03.59-.78 0-1.49-.45-1.74-1.08l-3.85 3.13c1.73 1.7 4.03 2.67 6.57 2.67z"/><path d="M5.57 15.02c-.21-.57-.34-1.18-.34-1.82s.13-1.25.34-1.82l-3.85-3.13c-1.33 2.48-2.05 5.27-2.05 8.14s.72 5.66 2.05 8.14l3.85-3.13z"/><path d="M12 7.07c1.64 0 3.07.55 4.23 1.56l3.47-3.47c-1.93-1.74-4.43-2.77-7.28-2.77-2.97 0-5.46.98-7.28 2.67l3.85 3.13c.25-.59.96-1.08 1.74-1.08.78 0 1.49.45 2.03.59z" opacity=".5"/><path d="M24 24H0V0h24v24z" fill="none"/></svg>
                            <span>Se connecter avec Google</span>
                        </button>
                        <p class="text-sm text-gray-400 mt-4">Utilisez votre compte Google pour une sauvegarde s√©curis√©e et synchronis√©e.</p>
                    </div>
                </div>
            </div>
        </div>



        <!-- Voyage Segments Modal -->
        <div id="voyage-segments-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-30 flex items-center justify-center p-4">
            <div class="bg-gray-900 border border-gray-700 rounded-lg shadow-xl flex flex-col ml-20" style="font-family: 'Merriweather', serif; width: 90%; height: 90%;">
                <!-- Header avec date et bouton fermer -->
                <div class="flex justify-between items-center p-4 border-b border-gray-700">
                    <div class="flex items-center space-x-4">
                        <h3 id="segment-title" class="text-xl font-bold text-white">17 Ninui</h3>
                        <span id="day-counter" class="text-sm text-gray-400">(Jour 1 sur 9)</span>
                    </div>
                    <button id="close-voyage-segments" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                </div>

                <div class="flex-grow overflow-hidden flex flex-col">
                    <!-- Message d'accueil ou contenu du segment -->
                    <div id="no-voyage-message" class="hidden p-8 text-center text-gray-400">
                        <h3 class="text-xl mb-4">Aucun voyage en cours</h3>
                        <p>Tracez un chemin sur la carte pour commencer un voyage et voir les d√©tails jour par jour.</p>
                    </div>

                    <!-- Contenu principal du segment -->
                    <div id="current-segment-display" class="flex-grow flex flex-col">
                        <!-- Barre de progression avec navigation -->
                        <div class="p-4">
                            <div id="voyage-progress-bar" class="hidden">
                                <div class="flex items-center justify-between mb-2">
                                    <button id="prev-segment-btn" class="px-2 py-1 bg-gray-600 hover:bg-gray-500 rounded text-white transition-colors">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>

                                    <div class="flex-1 mx-4">
                                        <div class="bg-gray-700 h-2 rounded-full relative">
                                            <div id="progress-fill" class="bg-blue-500 h-2 rounded-full transition-all duration-300"></div>
                                            <div id="progress-marker" class="absolute top-0 w-4 h-4 bg-blue-400 rounded-full border-2 border-white transform -translate-y-1"></div>
                                        </div>
                                    </div>

                                    <button id="next-segment-btn" class="px-2 py-1 bg-gray-600 hover:bg-gray-500 rounded text-white transition-colors">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Contenu scrollable du segment -->
                        <div id="segment-content" class="flex-grow overflow-y-auto px-6 pb-6">
                            <!-- Le contenu sera g√©n√©r√© dynamiquement -->
                        </div>
                    </div>

                    <!-- Message de fin de voyage -->
                    <div id="voyage-end-message" class="hidden p-4 border-t border-gray-700 text-center">
                        <div class="text-green-400 font-semibold mb-2">üèÅ Fin du Voyage</div>
                        <div class="text-sm text-gray-300">Votre p√©riple est termin√© !</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Settings Modal -->
        <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
            <div class="bg-gray-800 rounded-lg p-6 w-[90vw] h-[90vh] mx-4 flex flex-col">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6 flex-shrink-0">
                    <h3 class="text-xl font-bold"><i class="fas fa-cog mr-2"></i>Param√®tres</h3>
                    <button id="close-settings-modal" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Tabs -->
                <div id="settings-tabs" class="flex border-b border-gray-600 mb-6 flex-shrink-0">
                    <button class="settings-tab-button active px-6 py-3 text-white border-b-2 border-blue-500 font-medium" data-tab="maps">
                        <i class="fas fa-map-marked-alt mr-2"></i>Cartes
                    </button>
                    <button class="settings-tab-button px-6 py-3 text-gray-400 border-b-2 border-transparent font-medium hover:text-white" data-tab="adventurers">
                        <i class="fas fa-users mr-2"></i>Aventuriers
                    </button>
                    <button class="settings-tab-button px-6 py-3 text-gray-400 border-b-2 border-transparent font-medium hover:text-white" data-tab="quest">
                        <i class="fas fa-map mr-2"></i>Qu√™te
                    </button>
                    <button class="settings-tab-button px-6 py-3 text-gray-400 border-b-2 border-transparent font-medium hover:text-white" data-tab="season">
                        <i class="fas fa-leaf mr-2"></i>Saison
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="flex-grow overflow-hidden">
                    <!-- Cartes Tab -->
                    <div id="maps-tab" class="settings-tab-content active h-full flex flex-col">
                        <div class="flex justify-between items-center mb-4 flex-shrink-0">
                            <h4 class="text-lg font-semibold">Gestion des cartes</h4>
                            <div class="text-sm text-gray-400">
                                Dimensions recommand√©es : 5103 √ó 3296 pixels
                            </div>
                        </div>

                        <!-- Cartes actives -->
                        <div class="mb-6 flex-shrink-0">
                            <h5 class="text-blue-400 font-semibold mb-3">üéØ Cartes actives</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-900 rounded-lg p-4 border border-gray-600">
                                    <h6 class="text-white font-medium mb-2">Carte Joueur</h6>
                                    <div class="aspect-video bg-gray-800 rounded-lg mb-3 flex items-center justify-center overflow-hidden">
                                        <img id="active-player-map-preview" src="fr_tor_2nd_eriadors_map_page-0001.webp" alt="Carte Joueur" class="w-full h-full object-cover">
                                    </div>
                                    <div class="text-xs text-gray-400">Visible par les joueurs</div>
                                </div>
                                <div class="bg-gray-900 rounded-lg p-4 border border-gray-600">
                                    <h6 class="text-white font-medium mb-2">Carte Gardien</h6>
                                    <div class="aspect-video bg-gray-800 rounded-lg mb-3 flex items-center justify-center overflow-hidden">
                                        <img id="active-loremaster-map-preview" src="fr_tor_2nd_eriadors_map_page_loremaster.webp" alt="Carte Gardien" class="w-full h-full object-cover">
                                    </div>
                                    <div class="text-xs text-gray-400">R√©serv√©e au Gardien</div>
                                </div>
                            </div>
                        </div>

                        <!-- Liste des cartes disponibles -->
                        <div class="flex-grow overflow-hidden flex flex-col">
                            <div class="flex justify-between items-center mb-3 flex-shrink-0">
                                <h5 class="text-blue-400 font-semibold">üìã Toutes les cartes</h5>
                                <button id="add-map-btn" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm">
                                    <i class="fas fa-plus mr-1"></i>Ajouter une carte
                                </button>
                            </div>
                            <div id="maps-list" class="flex-grow overflow-y-auto bg-gray-900 rounded-lg p-4 border border-gray-600">
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="maps-grid">
                                    <!-- Les cartes seront ajout√©es ici dynamiquement -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aventuriers Tab -->
                    <div id="adventurers-tab" class="settings-tab-content h-full flex flex-col" style="display: none;">
                        <div class="flex justify-between items-center mb-4 flex-shrink-0">
                            <h4 class="text-lg font-semibold">Description du groupe d'aventuriers</h4>
                            <div class="flex items-center space-x-2">
                                <button id="edit-adventurers-btn" class="text-gray-400 hover:text-white p-2 rounded" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button id="generate-adventurers-wizard" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg flex items-center space-x-2 text-white font-medium transition-colors">
                                    <span class="gemini-icon">‚ú®</span>
                                    <span>Wizard</span>
                                </button>
                            </div>
                        </div>

                        <!-- Mode lecture -->
                        <div id="adventurers-read-mode" class="flex-grow overflow-y-auto bg-gray-900 rounded-lg p-4 border border-gray-600">
                            <div id="adventurers-content" class="prose prose-invert prose-sm max-w-none">
                                <p class="text-gray-400 italic">Aucune description d'aventuriers d√©finie.</p>
                            </div>
                        </div>

                        <!-- Mode √©dition -->
                        <div id="adventurers-edit-mode" class="hidden flex-grow flex flex-col">
                            <div class="flex justify-end space-x-2 mb-2">
                                <button id="cancel-adventurers-edit" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-sm">Annuler</button>
                                <button id="save-adventurers-edit" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm">Sauvegarder</button>
                            </div>
                            <textarea id="adventurers-group" rows="20" placeholder="D√©crivez votre groupe d'aventuriers dans les Terres du Milieu... (Markdown support√©)" class="flex-grow w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 resize-none font-mono text-sm"></textarea>
                            <div class="mt-2 text-xs text-gray-400">
                                Supports Markdown : **gras**, *italique*, # Titres, - listes, etc.
                            </div>
                        </div>
                    </div>

                    <!-- Qu√™te Tab -->
                    <div id="quest-tab" class="settings-tab-content h-full flex flex-col" style="display: none;">
                        <div class="flex justify-between items-center mb-4 flex-shrink-0">
                            <h4 class="text-lg font-semibold">Description de la qu√™te</h4>
                            <button id="edit-quest-btn" class="text-gray-400 hover:text-white p-2 rounded" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>

                        <!-- Mode lecture -->
                        <div id="quest-read-mode" class="flex-grow overflow-y-auto bg-gray-900 rounded-lg p-4 border border-gray-600">
                            <div id="quest-content" class="prose prose-invert prose-sm max-w-none">
                                <p class="text-gray-400 italic">Aucune description de qu√™te d√©finie.</p>
                            </div>
                        </div>

                        <!-- Mode √©dition -->
                        <div id="quest-edit-mode" class="hidden flex-grow flex flex-col">
                            <div class="flex justify-end space-x-2 mb-2">
                                <button id="cancel-quest-edit" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-sm">Annuler</button>
                                <button id="save-quest-edit" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm">Sauvegarder</button>
                            </div>
                            <textarea id="adventurers-quest" rows="15" placeholder="D√©crivez la qu√™te ou l'objectif commun du groupe... (Markdown support√©)" class="flex-grow w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 resize-none font-mono text-sm"></textarea>
                            <div class="mt-2 text-xs text-gray-400">
                                Supports Markdown : **gras**, *italique*, # Titres, - listes, etc.
                            </div>
                        </div>

                        <!-- Option Narration -->
                        <div class="mt-4 flex-shrink-0 bg-gray-900 rounded-lg p-4 border border-gray-600">
                            <h5 class="text-blue-400 font-semibold mb-3">üìñ Style de narration</h5>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <input type="radio" id="narration-detailed" name="narration-style" value="detailed" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                    <label for="narration-detailed" class="ml-3 block text-sm font-medium text-gray-300">
                                        <strong>Narration d√©taill√©e</strong>
                                        <br><span class="text-xs text-gray-400">Plusieurs paragraphes par jour dans un style litt√©raire √©vocateur</span>
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="narration-brief" name="narration-style" value="brief" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300" checked>
                                    <label for="narration-brief" class="ml-3 block text-sm font-medium text-gray-300">
                                        <strong>Narration br√®ve</strong>
                                        <br><span class="text-xs text-gray-400">Un paragraphe unique par jour dans un style concis (par d√©faut)</span>
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="narration-keywords" name="narration-style" value="keywords" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                    <label for="narration-keywords" class="ml-3 block text-sm font-medium text-gray-300">
                                        <strong>Points cl√©s seulement</strong>
                                        <br><span class="text-xs text-gray-400">Mots-cl√©s √©vocateurs pour inspiration du Meneur de Jeu</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Saison Tab -->
                    <div id="season-tab" class="settings-tab-content h-full flex flex-col" style="display: none;">
                        <!-- Header avec indicateur actuel -->
                        <div class="flex justify-between items-center mb-6 flex-shrink-0">
                            <h4 class="text-lg font-semibold">Saison et Calendrier</h4>
                            <div class="text-sm text-gray-400 text-right">
                                <div class="flex items-center">
                                    <span id="current-season-symbol" class="text-2xl mr-2">üå±</span>
                                    <div>
                                        <div id="current-season-text">Printemps-d√©but</div>
                                        <div id="current-calendar-date" class="text-xs text-gray-500">1 Gwaeron</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section Calendrier -->
                        <div class="mb-6 flex-shrink-0">
                            <div class="bg-gray-900 rounded-lg p-4 border border-gray-600">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="text-blue-400 font-semibold">üìÖ Calendrier</h5>
                                    <div class="flex space-x-2">
                                        <input type="file" id="calendar-file-input" accept=".csv" class="hidden">
                                        <button id="upload-calendar-btn" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                                            <i class="fas fa-upload mr-1"></i>Importer CSV
                                        </button>
                                        <button id="export-calendar-btn" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm" title="Exporter le calendrier">
                                            <i class="fas fa-download mr-1"></i>Exporter
                                        </button>
                                    </div>
                                </div>

                                <div id="calendar-status" class="mb-3 text-sm">
                                    <span id="calendar-status-text" class="text-gray-400">Aucun calendrier charg√©</span>
                                </div>

                                <div id="calendar-date-selector" class="hidden">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">Mois</label>
                                            <select id="calendar-month-select" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                                                <option value="">S√©lectionner un mois</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">Jour</label>
                                            <select id="calendar-day-select" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                                                <option value="">S√©lectionner un jour</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section Saisons (mode manuel quand pas de calendrier) -->
                        <div id="manual-seasons-section" class="flex-shrink-0">
                            <div class="grid grid-cols-3 gap-4">
                                <!-- Printemps -->
                                <div class="bg-gray-900 rounded-lg p-4 border border-gray-600">
                                    <h5 class="text-green-400 font-semibold mb-3 text-center">üå± Printemps</h5>
                                    <div class="space-y-2">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="season" value="printemps-debut" class="mr-3 text-green-500 focus:ring-green-500" checked>
                                            <span class="text-sm">D√©but</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="season" value="printemps-milieu" class="mr-3 text-green-500 focus:ring-green-500">
                                            <span class="text-sm">Milieu</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="season" value="printemps-fin" class="mr-3 text-green-500 focus:ring-green-500">
                                            <span class="text-sm">Fin</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- √ât√© -->
                                <div class="bg-gray-900 rounded-lg p-4 border border-gray-600">
                                    <h5 class="text-yellow-400 font-semibold mb-3 text-center">‚òÄÔ∏è √ât√©</h5>
                                    <div class="space-y-2">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="season" value="ete-debut" class="mr-3 text-yellow-500 focus:ring-yellow-500">
                                            <span class="text-sm">D√©but</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="season" value="ete-milieu" class="mr-3 text-yellow-500 focus:ring-yellow-500">
                                            <span class="text-sm">Milieu</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="season" value="ete-fin" class="mr-3 text-yellow-500 focus:ring-yellow-500">
                                            <span class="text-sm">Fin</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Automne -->
                                <div class="bg-gray-900 rounded-lg p-4 border border-gray-600">
                                    <h5 class="text-orange-400 font-semibold mb-3 text-center">üçÇ Automne</h5>
                                    <div class="space-y-2">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="season" value="automne-debut" class="mr-3 text-orange-500 focus:ring-orange-500">
                                            <span class="text-sm">D√©but</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="season" value="automne-milieu" class="mr-3 text-orange-500 focus:ring-orange-500">
                                            <span class="text-sm">Milieu</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="season" value="automne-fin" class="mr-3 text-orange-500 focus:ring-orange-500">
                                            <span class="text-sm">Fin</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Hiver -->
                                <div class="bg-gray-900 rounded-lg p-4 border border-gray-600 col-start-2">
                                    <h5 class="text-blue-400 font-semibold mb-3 text-center">‚ùÑÔ∏è Hiver</h5>
                                    <div class="space-y-2">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="season" value="hiver-debut" class="mr-3 text-blue-500 focus:ring-blue-500">
                                            <span class="text-sm">D√©but</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="season" value="hiver-milieu" class="mr-3 text-blue-500 focus:ring-blue-500">
                                            <span class="text-sm">Milieu</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="season" value="hiver-fin" class="mr-3 text-blue-500 focus:ring-blue-500">
                                            <span class="text-sm">Fin</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 text-xs text-gray-400 flex-shrink-0">
                            <i class="fas fa-info-circle mr-1"></i>
                            <span id="season-mode-info">Mode manuel : s√©lectionnez une saison. Importez un calendrier CSV pour synchroniser automatiquement les saisons avec les dates.</span>
                        </div>
                    </div>
                </div>

                <!-- Wizard Help -->
                <div class="mt-4 text-xs text-gray-400 flex-shrink-0">
                    <i class="fas fa-info-circle mr-1"></i>
                    Le Wizard g√©n√®re automatiquement un groupe de 2-5 aventuriers (nom, peuple de l'Eriador de la fin du Troisi√®me √Çge, occupation) unis par un objectif commun.
                </div>
            </div>
        </div>
    </div>

<script src="js/core/config.js"></script>
<script src="js/core/state.js"></script>
<script src="js/utils/dom.js"></script>
<script src="js/utils/helpers.js"></script>
<script src="js/api/auth.js"></script>
<script src="js/api/gemini.js"></script>
<script src="js/api/data-storage.js"></script>
<script src="js/features/locations.js"></script>
<script src="js/features/regions.js"></script>
<script src="js/features/journey.js"></script>
<script src="js/features/seasons.js"></script>
<script src="js/features/maps.js"></script>
<script src="js/ui/info-box.js"></script>
<script src="js/ui/modals.js"></script>
<script src="js/ui/filters.js"></script>
<script src="js/ui/main-ui.js"></script>
<script src="js/managers/voyage-manager.js"></script>
<script src="js/core/app.js"></script>
</body>
</html>