
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests Unitaires - Voyages en Terre du Milieu</title>
    <script src="https://cdn.jsdelivr.net/npm/jest@29.7.0/dist/jest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1f2937;
            color: white;
        }
        .test-results {
            background-color: #374151;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .test-passed {
            color: #10b981;
        }
        .test-failed {
            color: #ef4444;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body>
    <h1>Tests Unitaires - Voyages en Terre du Milieu</h1>
    
    <div>
        <button onclick="runAllTests()">Exécuter tous les tests</button>
        <button onclick="runMapTests()">Tests de carte</button>
        <button onclick="runDataTests()">Tests de données</button>
        <button onclick="clearResults()">Effacer les résultats</button>
    </div>
    
    <div id="test-results" class="test-results"></div>
    
    <script>
        // Simuler les fonctions principales pour les tests
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function findNearestLocation(point, locations = []) {
            if (!point || locations.length === 0) return null;
            
            let nearest = null;
            let minDistance = Infinity;
            
            locations.forEach(loc => {
                if (loc.coordinates) {
                    const distance = Math.sqrt(
                        Math.pow(loc.coordinates.x - point.x, 2) +
                        Math.pow(loc.coordinates.y - point.y, 2)
                    );
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = loc;
                    }
                }
            });
            
            return nearest;
        }
        
        function pixelsToMiles(pixels) {
            return Math.round(pixels * (1150 / 5103));
        }
        
        function milesToDays(miles) {
            return Math.ceil(miles / 20);
        }
        
        function validateLocation(location) {
            return location && 
                   location.name && 
                   location.name.trim() !== '' &&
                   location.coordinates &&
                   typeof location.coordinates.x === 'number' &&
                   typeof location.coordinates.y === 'number';
        }
        
        function validateRegion(region) {
            return region &&
                   region.name &&
                   region.name.trim() !== '' &&
                   region.points &&
                   Array.isArray(region.points) &&
                   region.points.length >= 3;
        }
        
        // Framework de test simple
        class SimpleTestFramework {
            constructor() {
                this.tests = [];
                this.results = [];
            }
            
            test(name, fn) {
                this.tests.push({ name, fn });
            }
            
            expect(actual) {
                return {
                    toBe: (expected) => {
                        if (actual === expected) {
                            return { passed: true };
                        }
                        throw new Error(`Expected ${expected}, got ${actual}`);
                    },
                    toContain: (expected) => {
                        if (actual.includes(expected)) {
                            return { passed: true };
                        }
                        throw new Error(`Expected "${actual}" to contain "${expected}"`);
                    },
                    toHaveLength: (expected) => {
                        if (actual.length === expected) {
                            return { passed: true };
                        }
                        throw new Error(`Expected length ${expected}, got ${actual.length}`);
                    }
                };
            }
            
            run() {
                this.results = [];
                
                this.tests.forEach(test => {
                    try {
                        test.fn();
                        this.results.push({
                            name: test.name,
                            passed: true
                        });
                    } catch (error) {
                        this.results.push({
                            name: test.name,
                            passed: false,
                            error: error.message
                        });
                    }
                });
                
                return this.results;
            }
        }
        
        const framework = new SimpleTestFramework();
        
        // Tests de distance
        framework.test('should convert pixels to miles correctly', () => {
            const pixels = 1000;
            const result = pixelsToMiles(pixels);
            const expected = Math.round(1000 * (1150 / 5103));
            framework.expect(result).toBe(expected);
        });
        
        framework.test('should convert miles to days correctly', () => {
            const miles = 40;
            const result = milesToDays(miles);
            framework.expect(result).toBe(2);
        });
        
        // Tests de validation
        framework.test('should validate location data correctly', () => {
            const validLocation = {
                id: 1,
                name: 'Test Location',
                coordinates: { x: 100, y: 200 },
                color: 'blue'
            };
            framework.expect(validateLocation(validLocation)).toBe(true);
        });
        
        framework.test('should invalidate empty location name', () => {
            const invalidLocation = {
                id: 1,
                name: '',
                coordinates: { x: 100, y: 200 }
            };
            framework.expect(validateLocation(invalidLocation)).toBe(false);
        });
        
        framework.test('should validate region data correctly', () => {
            const validRegion = {
                id: 1,
                name: 'Test Region',
                points: [
                    { x: 100, y: 100 },
                    { x: 200, y: 100 },
                    { x: 150, y: 200 }
                ],
                color: 'green'
            };
            framework.expect(validateRegion(validRegion)).toBe(true);
        });
        
        // Tests utilitaires
        framework.test('should escape HTML correctly', () => {
            const result = escapeHtml('<script>alert("test")</script>');
            framework.expect(result).toContain('&lt;script&gt;');
            framework.expect(result).toContain('&gt;');
        });
        
        framework.test('should find nearest location', () => {
            const point = { x: 100, y: 100 };
            const locations = [
                { id: 1, name: 'Close', coordinates: { x: 105, y: 105 }},
                { id: 2, name: 'Far', coordinates: { x: 500, y: 500 }}
            ];
            
            const nearest = findNearestLocation(point, locations);
            framework.expect(nearest.name).toBe('Close');
        });
        
        function runAllTests() {
            const results = framework.run();
            displayResults(results);
        }
        
        function runMapTests() {
            // Exécuter seulement les tests liés à la carte
            const mapTests = framework.tests.filter(test => 
                test.name.includes('pixels') || test.name.includes('miles')
            );
            
            const results = [];
            mapTests.forEach(test => {
                try {
                    test.fn();
                    results.push({ name: test.name, passed: true });
                } catch (error) {
                    results.push({ name: test.name, passed: false, error: error.message });
                }
            });
            
            displayResults(results, 'Tests de carte');
        }
        
        function runDataTests() {
            // Exécuter seulement les tests de validation
            const dataTests = framework.tests.filter(test => 
                test.name.includes('validate') || test.name.includes('find')
            );
            
            const results = [];
            dataTests.forEach(test => {
                try {
                    test.fn();
                    results.push({ name: test.name, passed: true });
                } catch (error) {
                    results.push({ name: test.name, passed: false, error: error.message });
                }
            });
            
            displayResults(results, 'Tests de données');
        }
        
        function displayResults(results, title = 'Résultats des tests') {
            const resultsDiv = document.getElementById('test-results');
            
            const passed = results.filter(r => r.passed).length;
            const total = results.length;
            
            let html = `<h3>${title}</h3>`;
            html += `<p><strong>${passed}/${total} tests réussis</strong></p>`;
            
            results.forEach(result => {
                const className = result.passed ? 'test-passed' : 'test-failed';
                const status = result.passed ? '✓' : '✗';
                html += `<div class="${className}">`;
                html += `${status} ${result.name}`;
                if (!result.passed && result.error) {
                    html += ` - ${result.error}`;
                }
                html += '</div>';
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }
    </script>
</body>
</html>
